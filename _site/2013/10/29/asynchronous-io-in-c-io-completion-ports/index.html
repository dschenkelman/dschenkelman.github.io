<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Asynchronous I/O in C#: I/O Completion Ports &#8211; A sea of code</title>
<meta name="description" content="Pseudo-random thoughts related to software development...">
<meta name="keywords" content="C#">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/site-logo.jpg">
<meta name="twitter:title" content="Asynchronous I/O in C#: I/O Completion Ports">
<meta name="twitter:description" content="Pseudo-random thoughts related to software development...">
<meta name="twitter:creator" content="@dschenkelman">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Asynchronous I/O in C#: I/O Completion Ports">
<meta property="og:description" content="Pseudo-random thoughts related to software development...">
<meta property="og:url" content="/2013/10/29/asynchronous-io-in-c-io-completion-ports/">
<meta property="og:site_name" content="A sea of code">





<link rel="canonical" href="/2013/10/29/asynchronous-io-in-c-io-completion-ports/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="A sea of code Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.min.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">j

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
	        
			<li>
				
					<a href="/">Home</a>
				 
			</li>
	        
			<li>
				
					<a href="/about/">About</a>
				 
			</li>
	        
			<li>
				
					<a href="/articles/">Articles</a>
				 
			</li>
	        
	        <li><a href="/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
	        <li class="dosearch"><i class="icon-search"></i> Search</li>
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="search-wrapper">
	<div class="search-form">
		<input type="text" class="search-field" placeholder="Search...">
		<i class="icon-remove-sign icon-2x"></i>
		<ul class="search-results post-list"></ul><!-- /.search-results -->
	</div><!-- /.search-form -->
</div><!-- ./search-wrapper -->

<header class="masthead">
	<div class="wrap">
        
    		<a href="/" class="site-logo" rel="home" title="A sea of code"><img src="/images/site-logo.jpg" width="200" height="200" alt="A sea of code logo" class="animated fadeInUp"></a>
        
        <h1 class="site-title animated fadeIn"><a href="/">A sea of code</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Pseudo-random thoughts related to software development...</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="/tags/#C#" title="Pages tagged C#">C#</a></span>
        
          <h1 class="entry-title">Asynchronous I/O in C#: I/O Completion Ports</h1>
        
      </header>
      <footer class="entry-meta">
        <img src="/images/bio-photo.jpg" alt="Damian Schenkelman photo" class="author-photo">
        <span class="author vcard">By <span class="fn"><a href="/about/" title="About Damian Schenkelman">Damian Schenkelman</a></span></span>
        <span class="entry-date date published"><time datetime="2013-10-29T00:00:00-04:00"><i class="icon-calendar-empty"></i> October 29, 2013</time></span>
        
        <span class="entry-comments"><i class="icon-comment-alt"></i> <a href="#disqus_thread">Comment</a></span>
        <span><a href="/2013/10/29/asynchronous-io-in-c-io-completion-ports/" rel="bookmark" title="Asynchronous I/O in C#: I/O Completion Ports"><i class="icon-link"></i> Permalink</a></span>
        
      </footer>
      <div class="entry-content">
        <p>I finally got around to writing this blog post as I feel it has been a personal debt for some time now. After <a href="http://blogs.southworks.net/dschenkelman/2013/08/02/asynchronous-io-in-c-introduction/">introducing async I/O in C#</a>, I spent a lot of time thinking about how to write about the topic of this blog post so let's jump right into it.</p>
<h2>What are I/O completion ports?</h2>
<p>As <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa365198(v=vs.85).aspx">this article</a> explains, an I/O Completion Port (IOCP from now on) is a queue-like operating system object that can be used to simultaneously manage multiple I/O operations. This is done by associating multiple <em>file handles</em> (not necessarily to a file, any asynchronous-able I/O endpoint) to a single IOCP and monitoring it for changes. Whenever an operation on any of the <em>file handles</em> completes, and I/O completion packet is queued into the IOCP.</p>
<p>I think the following picture does a better job at explaining the concept:</p>
<p><a href="http://blogs.southworks.net/dschenkelman/files/2013/10/image3.png"><img style="padding-top: 0px;padding-left: 0px;padding-right: 0px;border: 0px" title="image" alt="image" src="http://blogs.southworks.net/dschenkelman/files/2013/10/image_thumb3.png" width="612" height="392" border="0" /></a></p>
<h2>What do they have to do with asynchronous I/O in C#?</h2>
<p>Underneath the covers, an asynchronous operation could be implemented in many different ways.</p>
<blockquote><p>The important part about asynchrony is that it is relative to the caller.</p></blockquote>
<p>That means that one possible alternative could be to actually spin up a new  orker thread and perform a blocking call in it. Although that might not be what we want in every scenario (we are blocking a worker thread, just not the caller's thread) it is still asynchronous from a caller's perspective.</p>
<p>Another alternative that some framework components implement is using IOCP together with completion port threads. I did not know about this before, but <a href="http://msdn.microsoft.com/en-us/library/3dasc8as.aspx">ThreadPool</a> threads can be either worker threads or completion port threads (this is explained with detail in <a href="http://msdn.microsoft.com/en-us/library/ms973903.aspx">this article</a>).  With this approach, the ThreadPool is in charge of monitoring IOCPs and dispatching tasks to completion port threads that are in charge of handling the completion of an operation (also shown in <a href="http://msdn.microsoft.com/en-us/library/ms973903.aspx">this article</a>). How IOCP and the CLR interact is explained with more detail in Chapter 28 of <a href="http://www.amazon.es/Clr-Via-C-Developer-Reference/dp/0735667454">CLR via C# 4th Edition</a>.</p>
<p><a href="http://blogs.southworks.net/dschenkelman/files/2013/10/image10.png"><img style="padding-top: 0px;padding-left: 0px;padding-right: 0px;border: 0px" title="image" alt="image" src="http://blogs.southworks.net/dschenkelman/files/2013/10/image10_thumb.png" width="614" height="320" border="0" /></a></p>
<p>Some of the benefits of using IOCP are:</p>
<ul>
<li>All I/O operations can be registered to the same completion port object (simplifying the CLRs job).</li>
<li>We avoid blocking any of our own threads and ThreadPool worker threads.</li>
<li>We get automatic thread management, which minimizes context switching and gives our main thread more CPU time.</li>
</ul>
<h2>Show me some code…</h2>
<p>The link to the working code is in the samples section (bottom of the post), but this is a high level overview of how you would work with a completion port.</p>
<p>The first thing to do is create one and store a handle to it.</p>
<code data-gist-id="a5f8343f78492397f73b" data-gist-file="CreatePort.cs"></code>
<p>After that, whenever you create a <em>file handle</em> for asynchronous I/O you associate it to the IOCP.</p>
<code data-gist-id="a5f8343f78492397f73b" data-gist-file="CreateFile.cs"></code>
<p>Finally, whenever you perform an operation you must specify a callback and get a pointer to a <strong>NativeOverlapped*</strong> structure:</p>
<code data-gist-id="a5f8343f78492397f73b" data-gist-file="Overlapped.cs"></code>
<h2>How is the callback invoked?</h2>
<p>You might have noticed that the previous code only provides a callback, but it is never actually invoked. This is the role of a separate component, which we are using to simulate a completion port thread:</p>
<code data-gist-id="a5f8343f78492397f73b" data-gist-file="Thread.cs"></code>
<p>That component is in charge of checking the completion port for queued elements and invoking the related asynchronous callback (and also some cleanup).</p>
<code data-gist-id="a5f8343f78492397f73b" data-gist-file="IOCompletionWorker.cs"></code>
<h2>Samples</h2>
<p>Together with <a href="http://blogs.southworks.net/mconverti/">Mariano Converti</a> we held a talk some time ago introducing this subject, and created a <a href="https://github.com/dschenkelman/async-io-talk">GitHub repo</a> for the code. Under the source folder you will find three samples:</p>
<ol>
<li><strong>IOCompletionPorts</strong>: Shows how to create a completion port from C# code by taking advantage of <a href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.dllimportattribute.aspx">DllImport</a>. It gives an idea a high level idea of how things could be implemented underneath the covers (of course the code is nowhere near reusable), and provides a full working sample for the code provided above.</li>
<li><strong>ThreadPoolsSample</strong>: Shows that asynchronous callbacks are invoked in thread pool threads.</li>
<li><strong>CompletionPortThreadsSample</strong>:Shows that some asynchronous callbacks are invoked in completion port threads, while others are invoked in worked threads.</li>
</ol>

        <div id="disqus_thread"></div><!-- /#disqus_thread -->
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/2013/09/24/spanish-webcast-disponible-arquitectura-mvvm-para-la-construccin-de-aplicaciones-windows-store/" class="btn" title="[Spanish] Webcast Disponible: Arquitectura MVVM para la construcción de aplicaciones Windows Store">Previous article</a>
      
      
        <a href="/2013/11/29/asynchronous-io-in-c-why-tasks-a-k-a-promises-futures/" class="btn" title="Asynchronous I/O in C#: Why tasks (a.k.a. promises, futures)?">Next article</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2014 Damian Schenkelman. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/so-simple/">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/dschenkelman" title="Damian Schenkelman on Twitter" target="_blank"><i class="icon-twitter icon-2x"></i></a>
	
	
	<a href="http://linkedin.com/in/damianschenkelman" title="Damian Schenkelman on LinkedIn" target="_blank"><i class="icon-linkedin icon-2x"></i></a>
	
	
	
	<a href="http://github.com/dschenkelman" title="Damian Schenkelman on Github" target="_blank"><i class="icon-github icon-2x"></i></a>
	
</div><!-- /.social-icons -->
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/gist-embed/1.7/gist-embed.min.js"></script>


<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : '/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {

     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };

    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });

      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-50875301-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dschenkelman'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	        

</body>
</html>
