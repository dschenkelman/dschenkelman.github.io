<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Asynchronous I/O in C#: Why tasks (a.k.a. promises, futures)? &#8211; A sea of code</title>
<meta name="description" content="Pseudo-random thoughts related to software development...">
<meta name="keywords" content="C#">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/site-logo.jpg">
<meta name="twitter:title" content="Asynchronous I/O in C#: Why tasks (a.k.a. promises, futures)?">
<meta name="twitter:description" content="Pseudo-random thoughts related to software development...">
<meta name="twitter:creator" content="@dschenkelman">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Asynchronous I/O in C#: Why tasks (a.k.a. promises, futures)?">
<meta property="og:description" content="Pseudo-random thoughts related to software development...">
<meta property="og:url" content="http://localhost:4000/2013/11/29/asynchronous-io-in-c-why-tasks-a-k-a-promises-futures/">
<meta property="og:site_name" content="A sea of code">





<link rel="canonical" href="http://localhost:4000/2013/11/29/asynchronous-io-in-c-why-tasks-a-k-a-promises-futures/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="A sea of code Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.min.css">
<!-- Webfonts -->
<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/gist-embed/1.7/gist-embed.min.js"></script>

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
	        
			<li>
				
					<a href="http://localhost:4000/">Home</a>
				 
			</li>
	        
			<li>
				
					<a href="http://localhost:4000/about/">About</a>
				 
			</li>
	        
			<li>
				
					<a href="/articles/">Articles</a>
				 
			</li>
	        
	        <li><a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
	        <li class="dosearch"><i class="icon-search"></i> Search</li>
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="search-wrapper">
	<div class="search-form">
		<input type="text" class="search-field" placeholder="Search...">
		<i class="icon-remove-sign icon-2x"></i>
		<ul class="search-results post-list"></ul><!-- /.search-results -->
	</div><!-- /.search-form -->
</div><!-- ./search-wrapper -->

<header class="masthead">
	<div class="wrap">
        
    		<a href="http://localhost:4000/" class="site-logo" rel="home" title="A sea of code"><img src="http://localhost:4000/images/site-logo.jpg" width="200" height="200" alt="A sea of code logo" class="animated fadeInUp"></a>
        
        <h1 class="site-title animated fadeIn"><a href="http://localhost:4000/">A sea of code</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Pseudo-random thoughts related to software development...</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="http://localhost:4000/tags/#C#" title="Pages tagged C#">C#</a></span>
        
          <h1 class="entry-title">Asynchronous I/O in C#: Why tasks (a.k.a. promises, futures)?</h1>
        
      </header>
      <footer class="entry-meta">
        <img src="http://localhost:4000/images/bio-photo.jpg" alt="Damian Schenkelman photo" class="author-photo">
        <span class="author vcard">By <span class="fn"><a href="http://localhost:4000/about/" title="About Damian Schenkelman">Damian Schenkelman</a></span></span>
        <span class="entry-date date published"><time datetime="2013-11-29T00:00:00-05:00"><i class="icon-calendar-empty"></i> November 29, 2013</time></span>
        
        
        <span><a href="http://localhost:4000/2013/11/29/asynchronous-io-in-c-why-tasks-a-k-a-promises-futures/" rel="bookmark" title="Asynchronous I/O in C#: Why tasks (a.k.a. promises, futures)?"><i class="icon-link"></i> Permalink</a></span>
        
      </footer>
      <div class="entry-content">
        <p>In previous posts I provided an <a href="http://blogs.southworks.net/dschenkelman/2013/08/02/asynchronous-io-in-c-introduction/">introduction to asynchronous I/O in C#</a>, and also <a href="http://blogs.southworks.net/dschenkelman/2013/10/29/asynchronous-io-in-c-io-completion-ports/">dug a bit deeper into I/O completion ports</a>, which is one of the possible mechanisms that the .NET frameworks uses to accomplish this.</p>
<p>In this blog post we are going to go over the benefits of using the <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.task%28v=vs.110%29.aspx">Task</a> abstraction to represent asynchronous operations. Before I get started, I recommend that if you have never watched <a href="http://www.youtube.com/watch?v=hf1T_AONQJU" target="_blank">this video</a> you should go ahead and do it. Michael Jackson (<a href="https://twitter.com/mjackson">@mjackson</a>) and Domenic Denicola (<a href="https://twitter.com/domenic">@domenic</a>) do a great job explaining the benefits of promises.</p>
<h2>What are tasks?</h2>
<p>A Task is an object oriented abstraction that represents an asynchronous operation. It does not carry any special connotation as to how that operation is being performed (see my <a href="http://blogs.southworks.net/dschenkelman/2013/10/29/asynchronous-io-in-c-io-completion-ports/">previous post</a>). The concept of task is similar to the concept of promise or future and, as a matter of fact, in the <a href="http://blogs.msdn.com/b/pfxteam/archive/2008/06/02/8567093.aspx">Parallel Extensions CTP the class' original name was Future</a>.</p>
<p>That being said, all of the operations for which the .NET framework now returns a Task used to always be available but were somewhat harder to use. Let's look at a couple of examples so I can better express what I mean.</p>
<h2>A walk through history lane (with examples)</h2>
<p>In the following examples, let's assume that our goal is to download HTML from a couple of URLs and once both downloads are done we need to do something with the HTML. What we are going to do is compare how the <a href="http://msdn.microsoft.com/en-us/library/jj152938%28v=vs.110%29.aspx">different proposals for asynchronous programming in .NET</a> allow you to do this.</p>
<p>The source code for the samples can be found <a href="https://github.com/dschenkelman/async-io-talk/tree/master/src/AsynchronousPatterns">at GitHub</a>. I have tried to make all samples look similar, which leads to a bit of code duplication, but I think that makes the comparisons simpler. Basically, all samples follow this model:</p>
<code data-gist-id="af129e88ebb996f2a152" data-gist-file="Model.cs"></code>
<h3>Asynchronous Programming Model (APM)</h3>
<p>The first model that the Framework proposed for asynchronous programming was the <a href="http://msdn.microsoft.com/en-us/library/ms228963%28v=vs.110%29.aspx">asynchronous programming model</a>.</p>
<p>As you can see in the code below, we need to add an extra variable to keep track of the amount of pending requests. Additionally, we need to add a lock object to avoid a race condition for downloads that complete at the same time (if you want to try it out just remove the lock and add a Thread.Sleep(10000) after decrementing the pending count). Imagine the work that you would need to do to add error handling…</p>
<code data-gist-id="af129e88ebb996f2a152" data-gist-file="APM.cs"></code>
<h3>Event-based asynchronous pattern (EAP)</h3>
<p>After APM came the <a href="http://www.google.com.ar/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=0CC0QFjAA&amp;url=http%3A%2F%2Fmsdn.microsoft.com%2Fen-us%2Flibrary%2Fwewwczdw%28v%3Dvs.110%29.aspx&amp;ei=N5iYUvnDEqWpsAS3wYGIAQ&amp;usg=AFQjCNFHonNYzGLtuP8u3HhDsUNMWv1k_Q&amp;sig2=JJL0WSiZS-pjY4qrumRfOA&amp;bvm=bv.57155469,d.cWc">event-based asynchronous pattern</a>. It's similar to the APM example, but instead of using callbacks and <a href="http://msdn.microsoft.com/en-us/library/system.iasyncresult%28v=vs.110%29.aspx">IAsyncResult</a> it leverages <a href="http://msdn.microsoft.com/en-us/library/awbftdfh.aspx">events</a>. An interesting addition to this model is the possibility of cancelling a particular asynchronous operation (not shown here, it is just part of the spec).</p>
<code data-gist-id="af129e88ebb996f2a152" data-gist-file="Events.cs"></code>
<h3>Task-based asynchronous pattern (TPM)</h3>
<p>Finally, we get to the <a href="http://msdn.microsoft.com/en-us/library/hh873175%28v=vs.110%29.aspx">task-based asynchronous pattern</a>. The relevant parts here are:</p>
<ul>
<li>The usage of the <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.task.whenall%28v=vs.110%29.aspx">Task.WhenAll</a>, which greatly reduces the amount of code required to get this working, but most importantly makes the intent clear.</li>
<li>The usage of <a href="http://msdn.microsoft.com/en-us/library/dd270696%28v=vs.110%29.aspx">ContinueWith</a>, which allows you to provide code that does some work when a task finishes and returns a new task that will be completed when the work is done.</li>
</ul>
<p><strong>Note: </strong>I’m not using <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh191443.aspx">async/await</a> as I want to focus on Tasks. In a future post, the relationship between tasks and async/await will be covered.</p>
<code data-gist-id="af129e88ebb996f2a152" data-gist-file="Tasks.cs"></code>
<h2>Abstracting APM and EAP with Tasks</h2>
<p>As I stated at the beginning of the blog post, Tasks represent an abstraction for an asynchronous operation. For that reason, all other programming models can be abstracted using Tasks. I have created a couple of extension methods that do this exact thing. These methods are just meant as an example. If you are going to be doing this for real you should first make sure that the methods <a href="http://msdn.microsoft.com/en-us/library/system.net.webrequest.getrequeststreamasync%28v=vs.110%29.aspx">are not already implemented</a>, and if that is that case use the <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.taskfactory.fromasync%28v=vs.110%29.aspx">TaskFactory class</a>.</p>
<code data-gist-id="af129e88ebb996f2a152" data-gist-file="Extensions.cs"></code>
<p>With those extensions the APM example is greatly simplified (I won’t show the updated EAP sample, as it looks similar).</p>
<code data-gist-id="af129e88ebb996f2a152" data-gist-file="APMWithExtensions.cs"></code>
<h2>A final example: Cancellation</h2>
<p>What if we wanted to only carry out work with only the first download that finishes (e.g.: useful when working against multiple CDNs) and also avoid performing unnecessary downloads? Then we have to find a way to execute code once the first Task completes and cancel the other one. The following code does just that (I'm not even going to bother doing this with the other models, it requires a lot more thinking). The key takeaways from the following code are:</p>
<ul>
<li>The usage of the <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.task.waitany%28v=vs.110%29.aspx">Task.WhenAny</a> to execute the continuation when the task that finishes sooner completes.</li>
<li>Providing <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.taskcontinuationoptions%28v=vs.110%29.aspx">TaskContinuationOptions</a> for the continuation.</li>
<li>Providing a cancellation Token for the download tasks and cancelling when the task that finishes sooner completes.</li>
</ul>
<code data-gist-id="af129e88ebb996f2a152" data-gist-file="Cancellation.cs"></code>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/2013/10/29/asynchronous-io-in-c-io-completion-ports/" class="btn" title="Asynchronous I/O in C#: I/O Completion Ports">Previous article</a>
      
      
        <a href="http://localhost:4000/2013/12/04/scriptcs-reducing-startup-time-by-caching-compiled-dlls/" class="btn" title="scriptcs: Reducing startup time by caching compiled .dlls">Next article</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2014 Damian Schenkelman. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/so-simple/">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="http://twitter.com/dschenkelman" title="Damian Schenkelman on Twitter" target="_blank"><i class="icon-twitter icon-2x"></i></a>
	
	
	<a href="http://linkedin.com/in/damianschenkelman" title="Damian Schenkelman on LinkedIn" target="_blank"><i class="icon-linkedin icon-2x"></i></a>
	
	
	
	<a href="http://github.com/dschenkelman" title="Damian Schenkelman on Github" target="_blank"><i class="icon-github icon-2x"></i></a>
	
</div><!-- /.social-icons -->
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>

<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : 'http://localhost:4000/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


	        

</body>
</html>
